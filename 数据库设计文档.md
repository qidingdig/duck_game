# ç‚¹åç³»ç»Ÿæ•°æ®åº“è®¾è®¡æ–‡æ¡£

## ğŸ“Š æ•°æ®åº“æ¦‚è¿°

ç‚¹åç³»ç»Ÿä½¿ç”¨ **SQLite** æ•°æ®åº“ï¼Œé‡‡ç”¨ Repository æ¨¡å¼å’Œæ•°æ®åº“æŠ½è±¡å±‚è®¾è®¡ï¼Œæ”¯æŒæ•°æ®åº“è¿ç§»å’Œç‰ˆæœ¬ç®¡ç†ã€‚

- **æ•°æ®åº“æ–‡ä»¶è·¯å¾„**ï¼š`data/roll_call.db`
- **æ•°æ®åº“ç‰ˆæœ¬**ï¼š1
- **è¿ç§»ç®¡ç†**ï¼š`data/database_migration.py`

## ğŸ—‚ï¸ æ•°æ®åº“è¡¨ç»“æ„

### 1. studentsï¼ˆå­¦ç”Ÿè¡¨ï¼‰

å­˜å‚¨å­¦ç”ŸåŸºæœ¬ä¿¡æ¯ã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| student_id | TEXT | PRIMARY KEY | å­¦å·ï¼ˆä¸»é”®ï¼‰ |
| name | TEXT | NOT NULL | å§“å |
| nickname | TEXT | NULL | æ˜µç§°ï¼ˆå¯é€‰ï¼‰ |
| photo_path | TEXT | NULL | ç…§ç‰‡è·¯å¾„ï¼ˆå¯é€‰ï¼‰ |
| cut_count | INTEGER | DEFAULT 0 | æ—·è¯¾æ¬¡æ•°ç»Ÿè®¡ |
| called_count | INTEGER | DEFAULT 0 | è¢«ç‚¹åæ¬¡æ•°ç»Ÿè®¡ |

**SQL åˆ›å»ºè¯­å¥**ï¼š
```sql
CREATE TABLE IF NOT EXISTS students (
    student_id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    nickname TEXT,
    photo_path TEXT,
    cut_count INTEGER DEFAULT 0,
    called_count INTEGER DEFAULT 0
);
```

**æ•°æ®æ¨¡å‹**ï¼š`data/models.py` - `Student` ç±»

### 2. student_leavesï¼ˆå­¦ç”Ÿè¯·å‡è¡¨ï¼‰

å­˜å‚¨å­¦ç”Ÿè¯·å‡è®°å½•ï¼Œä¸ç‚¹åä¼šè¯å…³è”ã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | è‡ªå¢ä¸»é”® |
| student_id | TEXT | NOT NULL, FOREIGN KEY | å­¦å·ï¼ˆå¤–é”®å…³è” students.student_idï¼‰ |
| session_code | TEXT | NOT NULL | ä¼šè¯ä»£ç ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD-HHMMï¼‰ |
| start_time | TEXT | NOT NULL | è¯·å‡å¼€å§‹æ—¶é—´ |
| end_time | TEXT | NOT NULL | è¯·å‡ç»“æŸæ—¶é—´ |
| reason | TEXT | NULL | è¯·å‡åŸå› ï¼ˆå¯é€‰ï¼‰ |

**SQL åˆ›å»ºè¯­å¥**ï¼š
```sql
CREATE TABLE IF NOT EXISTS student_leaves (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    student_id TEXT NOT NULL,
    session_code TEXT NOT NULL,
    start_time TEXT NOT NULL,
    end_time TEXT NOT NULL,
    reason TEXT,
    FOREIGN KEY(student_id) REFERENCES students(student_id)
);
```

**æ•°æ®æ¨¡å‹**ï¼š`data/models.py` - `StudentLeave` ç±»

**å…³é”®è¯´æ˜**ï¼š
- `session_code` ç”¨äºå…³è”åˆ°ç‰¹å®šçš„ç‚¹åä¼šè¯
- è¯·å‡è®°å½•ä¸ç‚¹åä¼šè¯ä¸€ä¸€å¯¹åº”ï¼Œé€šè¿‡ `session_code` åŒ¹é…

### 3. roll_callsï¼ˆç‚¹åä¼šè¯è¡¨ï¼‰

å­˜å‚¨æ¯æ¬¡ç‚¹åçš„ä¼šè¯ä¿¡æ¯ã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | è‡ªå¢ä¸»é”® |
| session_code | TEXT | NOT NULL | ä¼šè¯ä»£ç ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD-HHMMï¼Œå”¯ä¸€æ ‡è¯†ï¼‰ |
| mode | TEXT | NOT NULL | ç‚¹åæ–¹å¼ï¼ˆ"all" å…¨ç‚¹ / "partial" æŠ½ç‚¹ï¼‰ |
| strategy | TEXT | NOT NULL | é€‰æ‹©ç­–ç•¥ï¼ˆ"random" / "most_absent" / "least_called"ï¼‰ |
| selected_count | INTEGER | DEFAULT 0 | é€‰æ‹©çš„å­¦ç”Ÿæ•°é‡ |
| started_at | TEXT | NOT NULL | ç‚¹åå¼€å§‹æ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:MM:SSï¼‰ |

**SQL åˆ›å»ºè¯­å¥**ï¼š
```sql
CREATE TABLE IF NOT EXISTS roll_calls (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_code TEXT NOT NULL,
    mode TEXT NOT NULL,
    strategy TEXT NOT NULL,
    selected_count INTEGER DEFAULT 0,
    started_at TEXT NOT NULL
);
```

**æ•°æ®æ¨¡å‹**ï¼š`data/models.py` - `RollCall` ç±»

**å…³é”®è¯´æ˜**ï¼š
- `session_code` æ˜¯æ¯æ¬¡ç‚¹åçš„å”¯ä¸€æ ‡è¯†ï¼Œæ ¼å¼ï¼š`YYYY-MM-DD-HHMM`ï¼ˆä¾‹å¦‚ï¼š`2024-01-15-1430`ï¼‰
- ç²¾ç¡®åˆ°åˆ†é’Ÿï¼ŒåŒä¸€åˆ†é’Ÿå†…åªèƒ½æœ‰ä¸€æ¬¡ç‚¹å

### 4. roll_call_recordsï¼ˆç‚¹åè®°å½•è¡¨ï¼‰

å­˜å‚¨æ¯ä¸ªå­¦ç”Ÿçš„ç‚¹åçŠ¶æ€è®°å½•ã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | è‡ªå¢ä¸»é”® |
| roll_call_id | INTEGER | NOT NULL, FOREIGN KEY | ç‚¹åä¼šè¯IDï¼ˆå¤–é”®å…³è” roll_calls.idï¼‰ |
| student_id | TEXT | NOT NULL, FOREIGN KEY | å­¦å·ï¼ˆå¤–é”®å…³è” students.student_idï¼‰ |
| order_index | INTEGER | NOT NULL | ç‚¹åé¡ºåºï¼ˆä»1å¼€å§‹ï¼‰ |
| status | TEXT | NOT NULL | çŠ¶æ€ï¼ˆ"present" åˆ° / "absent" æ—·è¯¾ / "leave" è¯·å‡ / "late" è¿Ÿåˆ°ï¼‰ |
| called_time | TEXT | NOT NULL | ç‚¹åæ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:MM:SSï¼‰ |
| updated_time | TEXT | NULL | çŠ¶æ€æ›´æ–°æ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:MM:SSï¼Œå¯é€‰ï¼‰ |
| note | TEXT | NULL | å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰ |

**SQL åˆ›å»ºè¯­å¥**ï¼š
```sql
CREATE TABLE IF NOT EXISTS roll_call_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    roll_call_id INTEGER NOT NULL,
    student_id TEXT NOT NULL,
    order_index INTEGER NOT NULL,
    status TEXT NOT NULL,
    called_time TEXT NOT NULL,
    updated_time TEXT,
    note TEXT,
    FOREIGN KEY(roll_call_id) REFERENCES roll_calls(id),
    FOREIGN KEY(student_id) REFERENCES students(student_id)
);
```

**æ•°æ®æ¨¡å‹**ï¼š`data/models.py` - `RollCallRecord` ç±»

**çŠ¶æ€è¯´æ˜**ï¼š
- `present`ï¼šåˆ°
- `absent`ï¼šæ—·è¯¾
- `leave`ï¼šè¯·å‡
- `late`ï¼šè¿Ÿåˆ°

### 5. schema_versionï¼ˆæ•°æ®åº“ç‰ˆæœ¬è¡¨ï¼‰

å­˜å‚¨æ•°æ®åº“è¿ç§»ç‰ˆæœ¬ä¿¡æ¯ï¼ˆç³»ç»Ÿè¡¨ï¼‰ã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| version | INTEGER | PRIMARY KEY | ç‰ˆæœ¬å· |
| applied_at | TEXT | NOT NULL | åº”ç”¨æ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:MM:SSï¼‰ |

**SQL åˆ›å»ºè¯­å¥**ï¼š
```sql
CREATE TABLE IF NOT EXISTS schema_version (
    version INTEGER PRIMARY KEY,
    applied_at TEXT NOT NULL
);
```

## ğŸ”— è¡¨å…³ç³»å›¾

```
students (1) â”€â”€â”€â”€< (N) student_leaves
    â”‚
    â”‚ (1)
    â”‚
    â””â”€â”€â”€< (N) roll_call_records
              â”‚
              â”‚ (N)
              â”‚
              â””â”€â”€â”€> (1) roll_calls
```

**å…³ç³»è¯´æ˜**ï¼š
- `students` ä¸ `student_leaves`ï¼šä¸€å¯¹å¤šï¼ˆä¸€ä¸ªå­¦ç”Ÿå¯ä»¥æœ‰å¤šä¸ªè¯·å‡è®°å½•ï¼‰
- `students` ä¸ `roll_call_records`ï¼šä¸€å¯¹å¤šï¼ˆä¸€ä¸ªå­¦ç”Ÿå¯ä»¥æœ‰å¤šä¸ªç‚¹åè®°å½•ï¼‰
- `roll_calls` ä¸ `roll_call_records`ï¼šä¸€å¯¹å¤šï¼ˆä¸€ä¸ªç‚¹åä¼šè¯å¯ä»¥æœ‰å¤šä¸ªç‚¹åè®°å½•ï¼‰

## ğŸ“ æ•°æ®æ¨¡å‹å±‚

æ‰€æœ‰æ•°æ®æ¨¡å‹å®šä¹‰åœ¨ `data/models.py` ä¸­ï¼Œä½¿ç”¨ Python `dataclass`ï¼š

### Studentï¼ˆå­¦ç”Ÿæ¨¡å‹ï¼‰

```python
@dataclass
class Student:
    student_id: str
    name: str
    nickname: Optional[str] = None
    photo_path: Optional[str] = None
    cut_count: int = 0
    called_count: int = 0
```

### StudentLeaveï¼ˆè¯·å‡æ¨¡å‹ï¼‰

```python
@dataclass
class StudentLeave:
    id: Optional[int] = None
    student_id: str = ""
    session_code: str = ""
    start_time: str = ""
    end_time: str = ""
    reason: Optional[str] = None
```

### RollCallï¼ˆç‚¹åä¼šè¯æ¨¡å‹ï¼‰

```python
@dataclass
class RollCall:
    id: Optional[int] = None
    session_code: str = ""
    mode: str = ""
    strategy: str = ""
    selected_count: int = 0
    started_at: str = ""
```

### RollCallRecordï¼ˆç‚¹åè®°å½•æ¨¡å‹ï¼‰

```python
@dataclass
class RollCallRecord:
    id: Optional[int] = None
    roll_call_id: int = 0
    student_id: str = ""
    order_index: int = 0
    status: str = ""
    called_time: str = ""
    updated_time: Optional[str] = None
    note: Optional[str] = None
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### Repository æ¨¡å¼

æ•°æ®è®¿é—®å±‚é‡‡ç”¨ Repository æ¨¡å¼ï¼Œå®šä¹‰åœ¨ `data/repositories.py`ï¼š

1. **æŠ½è±¡æ¥å£å±‚**ï¼š
   - `StudentRepository` - å­¦ç”Ÿæ•°æ®è®¿é—®æ¥å£
   - `StudentLeaveRepository` - è¯·å‡æ•°æ®è®¿é—®æ¥å£
   - `RollCallRepository` - ç‚¹åä¼šè¯æ•°æ®è®¿é—®æ¥å£
   - `RollCallRecordRepository` - ç‚¹åè®°å½•æ•°æ®è®¿é—®æ¥å£

2. **SQLite å®ç°å±‚**ï¼š
   - `SQLiteStudentRepository` - å­¦ç”Ÿæ•°æ®è®¿é—®å®ç°
   - `SQLiteStudentLeaveRepository` - è¯·å‡æ•°æ®è®¿é—®å®ç°
   - `SQLiteRollCallRepository` - ç‚¹åä¼šè¯æ•°æ®è®¿é—®å®ç°
   - `SQLiteRollCallRecordRepository` - ç‚¹åè®°å½•æ•°æ®è®¿é—®å®ç°

### æ•°æ®åº“æŠ½è±¡å±‚

- **æ¥å£**ï¼š`data/database_interface.py` - `DatabaseInterface`
- **å®ç°**ï¼š`data/sqlite_database.py` - `SQLiteDatabase`

### æ•°æ®åº“è¿ç§»

- **ç®¡ç†ç±»**ï¼š`data/database_migration.py` - `DatabaseMigration`
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šé€šè¿‡ `schema_version` è¡¨ç®¡ç†
- **è‡ªåŠ¨è¿ç§»**ï¼šé¦–æ¬¡è¿è¡Œæ—¶è‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„
- **ç¤ºä¾‹æ•°æ®**ï¼šé¦–æ¬¡è¿è¡Œæ—¶è‡ªåŠ¨å¡«å……ç¤ºä¾‹å­¦ç”Ÿå’Œè¯·å‡æ•°æ®

## ğŸ” å…³é”®æŸ¥è¯¢é€»è¾‘

### è¯·å‡åˆ¤æ–­

**å®ç°ä½ç½®**ï¼š`data/repositories.py` - `SQLiteStudentLeaveRepository.has_leave()`

```python
def has_leave(self, student_id: str, session_code: str) -> bool:
    query = """
        SELECT COUNT(*) FROM student_leaves
        WHERE student_id = ? AND session_code = ?
    """
    row = self.db.fetch_one(query, (student_id, session_code))
    return row[0] > 0 if row else False
```

**è°ƒç”¨æµç¨‹**ï¼š
1. `RollCallManager._prepare_roster()` - å‡†å¤‡åå•æ—¶æ£€æŸ¥æ¯ä¸ªå­¦ç”Ÿçš„è¯·å‡çŠ¶æ€
2. `RollCallService.has_leave()` - æœåŠ¡å±‚è°ƒç”¨
3. `SQLiteStudentLeaveRepository.has_leave()` - æ•°æ®åº“å±‚æŸ¥è¯¢

**åˆ¤æ–­é€»è¾‘**ï¼š
- æŸ¥è¯¢ `student_leaves` è¡¨ä¸­æ˜¯å¦å­˜åœ¨åŒ¹é…çš„è®°å½•
- åŒ¹é…æ¡ä»¶ï¼š`student_id` å’Œ `session_code` éƒ½åŒ¹é…
- å¦‚æœ COUNT > 0ï¼Œè¿”å› `True`ï¼ˆæœ‰è¯·å‡è®°å½•ï¼‰

### ç‚¹åè®°å½•æŸ¥è¯¢

**å®ç°ä½ç½®**ï¼š`services/roll_call_service.py` - `get_roll_call_summary()`

```python
def get_roll_call_summary(self, session_code: Optional[str] = None) -> List[Dict[str, Any]]:
    query = """
        SELECT r.session_code, r.started_at, rr.status, s.student_id, s.name
        FROM roll_call_records rr
        JOIN roll_calls r ON rr.roll_call_id = r.id
        JOIN students s ON rr.student_id = s.student_id
    """
    if session_code:
        query += " WHERE r.session_code = ?"
    query += " ORDER BY r.started_at DESC, rr.order_index ASC"
```

## ğŸ“ æ•°æ®æ“ä½œç¤ºä¾‹

### æ·»åŠ å­¦ç”Ÿ

```python
from tools.db_manager import DatabaseManager

manager = DatabaseManager()
manager.add_student(
    student_id="2023011",
    name="å”å°æ–°",
    nickname="å°æ–°",
    photo_path="assets/images/students/student11.png"
)
```

### æ·»åŠ è¯·å‡è®°å½•

```python
from tools.db_manager import DatabaseManager

manager = DatabaseManager()
manager.add_leave(
    student_id="2023001",
    session_code="2024-01-15-1430",
    start_time="2024-01-15 14:00:00",
    end_time="2024-01-15 16:00:00",
    reason="èº«ä½“ä¸é€‚"
)
```

### æŸ¥è¯¢ç‚¹åè®°å½•

```python
from services.roll_call_service import RollCallService

service = RollCallService()

# æŸ¥è¯¢æ‰€æœ‰è®°å½•
all_records = service.get_roll_call_summary()

# æŸ¥è¯¢ç‰¹å®šä¼šè¯
session_records = service.get_roll_call_summary(session_code="2024-01-15-1430")
```

## ğŸ”§ æ•°æ®åº“å·¥å…·

### DatabaseManager

ä½ç½®ï¼š`tools/db_manager.py`

æä¾›ä¾¿æ·çš„æ•°æ®åº“æ“ä½œæ¥å£ï¼Œæ”¯æŒï¼š
- å­¦ç”Ÿç®¡ç†ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
- è¯·å‡è®°å½•ç®¡ç†
- ç‚¹åä¼šè¯æŸ¥è¯¢
- ç‚¹åè®°å½•æŸ¥è¯¢

### å‘½ä»¤è¡Œå·¥å…·

å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œç›´æ¥æ“ä½œæ•°æ®åº“ï¼š

```bash
python -m tools.db_manager
```

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **session_code æ ¼å¼**ï¼š`YYYY-MM-DD-HHMM`ï¼Œç²¾ç¡®åˆ°åˆ†é’Ÿ
2. **æ—¶é—´æ ¼å¼**ï¼šæ‰€æœ‰æ—¶é—´å­—æ®µä½¿ç”¨å­—ç¬¦ä¸²æ ¼å¼ `YYYY-MM-DD HH:MM:SS`
3. **å¤–é”®çº¦æŸ**ï¼šSQLite é»˜è®¤ä¸å¼ºåˆ¶å¤–é”®çº¦æŸï¼Œä½†ä»£ç ä¸­å·²å®šä¹‰å…³ç³»
4. **æ•°æ®è¿ç§»**ï¼šæ•°æ®åº“ç‰ˆæœ¬é€šè¿‡ `schema_version` è¡¨ç®¡ç†ï¼Œæ”¯æŒæœªæ¥æ‰©å±•
5. **ç¤ºä¾‹æ•°æ®**ï¼šé¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨å¡«å……ç¤ºä¾‹æ•°æ®ï¼ˆå¦‚æœæ•°æ®åº“ä¸ºç©ºï¼‰

## ğŸ”„ æ•°æ®åº“è¿ç§»æµç¨‹

1. æ£€æŸ¥ `schema_version` è¡¨æ˜¯å¦å­˜åœ¨
2. è·å–å½“å‰æ•°æ®åº“ç‰ˆæœ¬
3. æ¯”è¾ƒå½“å‰ç‰ˆæœ¬ä¸ç›®æ ‡ç‰ˆæœ¬
4. æ‰§è¡Œç¼ºå¤±ç‰ˆæœ¬çš„è¿ç§»è„šæœ¬
5. æ›´æ–° `schema_version` è¡¨

å½“å‰æ•°æ®åº“ç‰ˆæœ¬ï¼š**1**

## ğŸ¯ ä¸šåŠ¡é€»è¾‘å±‚

### RollCallServiceï¼ˆç‚¹åæœåŠ¡ï¼‰

**ä½ç½®**ï¼š`services/roll_call_service.py`

**ä¸»è¦åŠŸèƒ½**ï¼š
- å­¦ç”Ÿç®¡ç†ï¼ˆæŸ¥è¯¢æ‰€æœ‰å­¦ç”Ÿï¼‰
- è¯·å‡è®°å½•ç®¡ç†ï¼ˆæ£€æŸ¥ã€æ·»åŠ è¯·å‡ï¼‰
- ç‚¹åä¼šè¯ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ä¼šè¯ï¼‰
- ç‚¹åè®°å½•ç®¡ç†ï¼ˆæ’å…¥ã€æŸ¥è¯¢è®°å½•ï¼‰
- æ•°æ®å¯¼å‡ºï¼ˆCSVã€XLSXæ ¼å¼ï¼‰

**å…³é”®æ–¹æ³•**ï¼š
- `get_all_students()` - è·å–æ‰€æœ‰å­¦ç”Ÿåˆ—è¡¨
- `has_leave(student_id, session_code)` - æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦æœ‰è¯·å‡è®°å½•
- `create_roll_call(session_code, mode, strategy, selected_count)` - åˆ›å»ºç‚¹åä¼šè¯
- `insert_record(roll_call_id, student_id, order_index, status, note)` - æ’å…¥ç‚¹åè®°å½•
- `list_all_sessions()` - åˆ—å‡ºæ‰€æœ‰ç‚¹åä¼šè¯
- `get_session_details(session_code)` - è·å–ä¼šè¯è¯¦ç»†è®°å½•
- `export_to_csv(session_code, file_path)` - å¯¼å‡ºä¸ºCSV
- `export_to_xlsx(session_code, file_path)` - å¯¼å‡ºä¸ºXLSX

### RollCallManagerï¼ˆç‚¹åç®¡ç†å™¨ï¼‰

**ä½ç½®**ï¼š`game/roll_call_manager.py`

**ä¸»è¦åŠŸèƒ½**ï¼š
- åè°ƒç‚¹åæµç¨‹ï¼ˆé…ç½®ã€å¼€å§‹ã€æ ‡è®°çŠ¶æ€ï¼‰
- ç®¡ç†ç‚¹åçŠ¶æ€ï¼ˆå½“å‰å­¦ç”Ÿã€å½“å‰ä¼šè¯ï¼‰
- å¤„ç†è¯·å‡éªŒè¯
- è¯­éŸ³æ’­æŠ¥å­¦ç”Ÿå§“å
- UIçª—å£ç®¡ç†

**å…³é”®æµç¨‹**ï¼š
1. `_on_start_config()` - å¼€å§‹ç‚¹åé…ç½®
   - åˆ›å»ºç‚¹åä¼šè¯
   - å‡†å¤‡å­¦ç”Ÿåå•
   - æ£€æŸ¥æ¯ä¸ªå­¦ç”Ÿçš„è¯·å‡çŠ¶æ€
   - æ ¹æ®ç­–ç•¥é€‰æ‹©å­¦ç”Ÿ
2. `_on_mark_status()` - æ ‡è®°å­¦ç”ŸçŠ¶æ€
   - éªŒè¯è¯·å‡çŠ¶æ€ï¼ˆå¦‚æœæ˜¯è¯·å‡ï¼‰
   - æ’å…¥ç‚¹åè®°å½•
   - æ¨è¿›åˆ°ä¸‹ä¸€ä¸ªå­¦ç”Ÿ
3. `_prepare_roster()` - å‡†å¤‡åå•
   - è·å–æ‰€æœ‰å­¦ç”Ÿ
   - æ£€æŸ¥è¯·å‡çŠ¶æ€
   - æ„å»ºåå•å­—å…¸

## ğŸ“‹ æ•°æ®æµç¨‹ç¤ºä¾‹

### å®Œæ•´çš„ç‚¹åæµç¨‹

```
1. ç”¨æˆ·è¾“å…¥"æˆ‘è¦ç‚¹å"
   â†“
2. RollCallManager._on_start_config()
   â†“
3. RollCallService.create_roll_call()
   - ç”Ÿæˆ session_code (YYYY-MM-DD-HHMM)
   - æ’å…¥ roll_calls è¡¨
   â†“
4. RollCallManager._prepare_roster()
   - RollCallService.get_all_students()
   - å¯¹æ¯ä¸ªå­¦ç”Ÿï¼šRollCallService.has_leave(student_id, session_code)
   - æŸ¥è¯¢ student_leaves è¡¨
   â†“
5. æ ¹æ®ç­–ç•¥é€‰æ‹©å­¦ç”Ÿ
   â†“
6. RollCallManager._advance_student()
   - æ˜¾ç¤ºå½“å‰å­¦ç”Ÿä¿¡æ¯
   - è¯­éŸ³æ’­æŠ¥å­¦ç”Ÿå§“å
   â†“
7. ç”¨æˆ·ç‚¹å‡»çŠ¶æ€æŒ‰é’®ï¼ˆåˆ°/è¯·å‡/æ—·è¯¾/è¿Ÿåˆ°ï¼‰
   â†“
8. RollCallManager._on_mark_status()
   - éªŒè¯è¯·å‡çŠ¶æ€ï¼ˆå¦‚æœæ˜¯è¯·å‡ï¼‰
   - RollCallService.insert_record()
   - æ’å…¥ roll_call_records è¡¨
   â†“
9. æ¨è¿›åˆ°ä¸‹ä¸€ä¸ªå­¦ç”Ÿï¼ˆé‡å¤æ­¥éª¤6-8ï¼‰
```

### è¯·å‡éªŒè¯æµç¨‹

```
1. å‡†å¤‡åå•æ—¶ï¼ˆ_prepare_rosterï¼‰
   â†“
2. å¯¹æ¯ä¸ªå­¦ç”Ÿè°ƒç”¨ has_leave(student_id, session_code)
   â†“
3. SQLiteStudentLeaveRepository.has_leave()
   - æŸ¥è¯¢ student_leaves è¡¨
   - WHERE student_id = ? AND session_code = ?
   â†“
4. è¿”å› True/Falseï¼Œå­˜å‚¨åœ¨å­¦ç”Ÿçš„ has_leave å­—æ®µ
   â†“
5. æ ‡è®°çŠ¶æ€æ—¶ï¼ˆ_on_mark_statusï¼‰
   - å¦‚æœ status == "leave" ä¸” has_leave == False
   - æ˜¾ç¤ºè­¦å‘Šï¼š"è¯¥åŒå­¦æœªæäº¤æœ¬èŠ‚è¯¾å‡æ¡ï¼Œæ— æ³•è®°å½•ä¸ºè¯·å‡ã€‚"
   - é˜»æ­¢æ ‡è®°ä¸ºè¯·å‡
```

## ğŸ” æ•°æ®å®Œæ•´æ€§

### å¤–é”®å…³ç³»

è™½ç„¶ SQLite é»˜è®¤ä¸å¼ºåˆ¶å¤–é”®çº¦æŸï¼Œä½†ä»£ç ä¸­å·²å®šä¹‰å…³ç³»ï¼š

- `student_leaves.student_id` â†’ `students.student_id`
- `roll_call_records.roll_call_id` â†’ `roll_calls.id`
- `roll_call_records.student_id` â†’ `students.student_id`

### æ•°æ®ä¸€è‡´æ€§

- `session_code` åœ¨ `roll_calls` å’Œ `student_leaves` ä¸­ä¿æŒä¸€è‡´
- `roll_call_id` åœ¨ `roll_calls` å’Œ `roll_call_records` ä¸­ä¿æŒä¸€è‡´
- `student_id` åœ¨æ‰€æœ‰ç›¸å…³è¡¨ä¸­ä¿æŒä¸€è‡´

### äº‹åŠ¡æ”¯æŒ

æ•°æ®åº“æ¥å£å±‚æ”¯æŒäº‹åŠ¡æ“ä½œï¼š
- `begin_transaction()` - å¼€å§‹äº‹åŠ¡
- `commit()` - æäº¤äº‹åŠ¡
- `rollback()` - å›æ»šäº‹åŠ¡

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶

- `data/models.py` - æ•°æ®æ¨¡å‹å®šä¹‰
- `data/database_interface.py` - æ•°æ®åº“æŠ½è±¡æ¥å£
- `data/sqlite_database.py` - SQLiteå®ç°
- `data/repositories.py` - Repositoryæ¨¡å¼å®ç°
- `data/database_migration.py` - æ•°æ®åº“è¿ç§»ç®¡ç†

### æœåŠ¡å±‚

- `services/roll_call_service.py` - ç‚¹åæœåŠ¡
- `game/roll_call_manager.py` - ç‚¹åç®¡ç†å™¨

### å·¥å…·

- `tools/db_manager.py` - æ•°æ®åº“ç®¡ç†å·¥å…·

