# 点名记录识别与导出说明

## 📋 当前实现

### 如何识别本次点名

程序使用 **`session_code`** 来唯一标识每次点名会话：

1. **生成方式**：
   ```python
   session_code = time.strftime("%Y-%m-%d-%H%M")
   ```
   - 格式：`YYYY-MM-DD-HHMM`（例如：`2024-01-15-1430`）
   - 精确到分钟，同一分钟内只能有一次点名

2. **存储位置**：
   - `roll_calls` 表中的 `session_code` 字段
   - 每个点名会话都有一个唯一的 `session_code`

3. **使用场景**：
   - 开始点名时生成并保存
   - 查询特定点名会话的记录
   - 请假记录关联到 `session_code`

### 数据库结构

```sql
-- 点名会话表
roll_calls:
  - id: 主键
  - session_code: 会话代码（唯一标识）
  - mode: 点名方式（all/partial）
  - strategy: 选择策略
  - selected_count: 选择人数
  - started_at: 开始时间

-- 点名记录表
roll_call_records:
  - id: 主键
  - roll_call_id: 关联到 roll_calls.id
  - student_id: 学生ID
  - order_index: 点名顺序
  - status: 状态（present/absent/leave/late）
  - called_time: 点名时间
  - note: 备注
```

### 当前功能

1. **查询功能**：
   - `get_roll_call_summary(session_code=None)` - 获取点名摘要
   - 支持按 `session_code` 过滤查询

2. **缺失功能**：
   - ❌ 没有UI界面展示点名记录
   - ❌ 没有导出功能（CSV/Excel）
   - ❌ 没有按日期/时间范围查询

## ✅ 已实现的功能

### 1. 展示功能

- ✅ 列出所有点名会话（按时间倒序）
- ✅ 查看单个会话的详细记录
- ✅ 显示会话信息（会话代码、开始时间、点名方式、策略、记录数）
- ✅ 显示记录详情（顺序、学号、姓名、状态、点名时间、备注）

### 2. 导出功能

- ✅ 导出为CSV格式
- ✅ 导出为Excel格式
- ✅ 支持导出所有记录
- ✅ 支持导出指定会话的记录

### 3. UI界面

- ✅ 创建了独立的记录查看窗口（`ui/roll_call_records_window.py`）
- ✅ 提供图形界面，方便查看和导出
- ✅ 支持通过命令打开：`查看点名记录`、`点名记录`、`导出点名记录`

## 📝 使用方法

### 通过命令打开

在对话窗口中输入以下任一命令：
- `查看点名记录`
- `点名记录`
- `导出点名记录`

### 功能说明

1. **会话列表**：
   - 显示所有点名会话
   - 按时间倒序排列
   - 显示会话代码、开始时间、点名方式、策略、记录数

2. **记录详情**：
   - 点击会话列表中的任意会话，查看该会话的详细记录
   - 显示每个学生的点名状态、时间等信息

3. **导出功能**：
   - **导出所有**：导出所有点名记录
   - **导出当前会话**：导出选中会话的记录
   - 支持CSV和Excel两种格式

## 🔍 查询示例

```python
from services.roll_call_service import RollCallService

service = RollCallService()

# 查询所有点名记录
all_records = service.get_roll_call_summary()

# 查询特定会话的记录
session_records = service.get_roll_call_summary(session_code="2024-01-15-1430")
```

## 📊 数据格式示例

```python
{
    "session_code": "2024-01-15-1430",
    "started_at": "2024-01-15 14:30:00",
    "status": "present",
    "student_id": "2023001",
    "name": "唐小雨"
}
```

