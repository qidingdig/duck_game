# 数据库操作工具说明

## ✅ 已创建的工具

为了方便修改数据库内容，我创建了以下工具：

### 1. **DatabaseManager类** (`tools/db_manager.py`)
   - 编程方式操作数据库的完整工具类
   - 支持所有CRUD操作
   - 提供便捷的查询和统计方法

### 2. **命令行工具** (`tools/db_manager.py`)
   - 快速执行常用操作
   - 支持学生管理和请假管理
   - 适合快速修改和查询

### 3. **辅助脚本** (`tools/db_helper.py`)
   - 提供常用操作的示例代码
   - 可以直接运行或参考

### 4. **快速示例** (`tools/quick_examples.py`)
   - 常用操作的代码示例
   - 复制粘贴即可使用

## 🚀 快速开始

### 方式一：命令行（最简单）

```bash
# 查看所有学生
python tools/db_manager.py student list

# 添加学生
python tools/db_manager.py student add --id 2023011 --name 唐小新 --nickname 新新

# 更新学生
python tools/db_manager.py student update --id 2023001 --name 新姓名 --cut 0 --called 20

# 删除学生
python tools/db_manager.py student delete --id 2023001

# 搜索学生
python tools/db_manager.py student search 唐小

# 查看统计
python tools/db_manager.py student stats
```

### 方式二：Python代码（最灵活）

```python
from tools.db_manager import DatabaseManager

# 初始化
manager = DatabaseManager()

# 查看所有学生
manager.print_students()

# 添加学生
manager.add_student(
    student_id="2023011",
    name="唐小新",
    nickname="新新",
)

# 更新学生
manager.update_student(
    "2023001",
    name="新姓名",
    cut_count=0,
    called_count=20,
)

# 批量更新
updates = [
    {'student_id': '2023001', 'cut_count': 0},
    {'student_id': '2023002', 'called_count': 20},
]
manager.batch_update_students(updates)

# 搜索
results = manager.search_students("唐小")

# 重置统计
manager.reset_student_statistics("2023001")
```

## 📋 常用操作

### 学生管理

| 操作 | 命令行 | Python代码 |
|------|--------|-----------|
| 列出所有学生 | `python tools/db_manager.py student list` | `manager.print_students()` |
| 添加学生 | `python tools/db_manager.py student add --id 2023011 --name 唐小新` | `manager.add_student(...)` |
| 更新学生 | `python tools/db_manager.py student update --id 2023001 --name 新名` | `manager.update_student(...)` |
| 删除学生 | `python tools/db_manager.py student delete --id 2023001` | `manager.delete_student(...)` |
| 重置统计 | `python tools/db_manager.py student reset --id 2023001` | `manager.reset_student_statistics(...)` |
| 搜索学生 | `python tools/db_manager.py student search 关键词` | `manager.search_students(...)` |

### 请假管理

| 操作 | 命令行 | Python代码 |
|------|--------|-----------|
| 列出请假 | `python tools/db_manager.py leave list` | `manager.list_leaves()` |
| 添加请假 | `python tools/db_manager.py leave add --student-id 2023001 --session 2024-11-25-AM --start "2024-11-25 08:00" --end "2024-11-25 10:00"` | `manager.add_leave(...)` |

## 💡 实用示例

### 示例1：批量重置所有学生统计

```python
from tools.db_manager import DatabaseManager

manager = DatabaseManager()
students = manager.list_students()

for student in students:
    manager.reset_student_statistics(student.student_id)

print(f"✓ 重置了 {len(students)} 名学生的统计信息")
```

### 示例2：批量添加学生

```python
from tools.db_manager import DatabaseManager

manager = DatabaseManager()

students_data = [
    ("2023011", "唐小新", "新新"),
    ("2023012", "唐小亮", "亮亮"),
    ("2023013", "唐小美", "美美"),
]

for student_id, name, nickname in students_data:
    manager.add_student(
        student_id=student_id,
        name=name,
        nickname=nickname,
    )

print(f"✓ 添加了 {len(students_data)} 名学生")
```

### 示例3：修改特定学生的信息

```python
from tools.db_manager import DatabaseManager

manager = DatabaseManager()

# 清零缺勤，设置被点名次数
manager.update_student(
    "2023001",
    cut_count=0,
    called_count=20,
    nickname="新昵称",
)

print("✓ 更新完成")
```

### 示例4：导出学生数据

```python
from tools.db_manager import DatabaseManager
import json

manager = DatabaseManager()
students = manager.list_students()

data = [student.to_dict() for student in students]
with open("students_export.json", "w", encoding="utf-8") as f:
    json.dump(data, f, ensure_ascii=False, indent=2)

print(f"✓ 导出 {len(students)} 名学生数据")
```

## 🔧 高级用法

### 直接使用Repository（更细粒度控制）

```python
from data.sqlite_database import SQLiteDatabase
from data.repositories import SQLiteStudentRepository
from data.models import Student

db = SQLiteDatabase("data/roll_call.db")
repo = SQLiteStudentRepository(db)

# 查找
student = repo.find_by_id("2023001")

# 保存
student = Student(
    student_id="2023001",
    name="新姓名",
    nickname="新昵称",
    cut_count=0,
    called_count=0,
)
repo.save(student)
```

### 执行自定义SQL

```python
from tools.db_manager import DatabaseManager

manager = DatabaseManager()

# 执行自定义查询
rows = manager.db.fetch_all("SELECT * FROM students WHERE cut_count > 5")

# 执行自定义更新
manager.db.execute("UPDATE students SET cut_count = 0 WHERE cut_count > 5")
```

## 📚 完整文档

详细文档请参考：
- `数据库操作指南.md` - 完整的使用指南
- `tools/db_manager.py` - 源代码和注释
- `tools/quick_examples.py` - 快速示例代码

## ⚠️ 注意事项

1. **备份数据库**：修改前建议备份
   ```bash
   cp data/roll_call.db data/roll_call.db.backup
   ```

2. **数据验证**：确保数据格式正确

3. **外键约束**：删除学生时注意相关记录

## 🎯 推荐使用方式

- **快速查看/修改**：使用命令行工具
- **批量操作**：使用Python代码
- **复杂逻辑**：直接使用Repository或DatabaseManager

## ✨ 总结

现在你可以通过以下方式方便地修改数据库：

1. ✅ **命令行工具** - 最简单快速
2. ✅ **DatabaseManager类** - 编程方式，最灵活
3. ✅ **Repository层** - 高级用法，完全控制

选择最适合你的方式即可！

