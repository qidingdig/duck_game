# 数据库操作指南

## 概述

提供了多种便捷的方式来修改数据库内容：

1. **DatabaseManager类** - 编程方式操作数据库
2. **命令行工具** - 快速执行常用操作
3. **辅助脚本** - 示例代码和快捷操作

## 方式一：使用DatabaseManager类（编程方式）

### 基本使用

```python
from tools.db_manager import DatabaseManager

# 初始化管理器
manager = DatabaseManager()  # 默认使用 data/roll_call.db
# 或指定路径
manager = DatabaseManager("data/roll_call.db")
```

### 学生管理

```python
# 列出所有学生
students = manager.list_students()
for student in students:
    print(f"{student.student_id} - {student.name}")

# 获取单个学生
student = manager.get_student("2023001")
if student:
    print(student.name)

# 添加学生
manager.add_student(
    student_id="2023011",
    name="唐小新",
    nickname="新新",
    photo_path="assets/images/students/student11.png",
    cut_count=0,
    called_count=0,
)

# 更新学生信息
manager.update_student(
    "2023001",
    name="新姓名",
    nickname="新昵称",
    cut_count=5,
    called_count=10,
)

# 删除学生
manager.delete_student("2023001")

# 重置学生统计信息
manager.reset_student_statistics("2023001")

# 批量更新学生
updates = [
    {'student_id': '2023001', 'cut_count': 0},
    {'student_id': '2023002', 'called_count': 20},
]
manager.batch_update_students(updates)

# 搜索学生
results = manager.search_students("唐小")
```

### 请假管理

```python
# 添加请假记录
leave_id = manager.add_leave(
    student_id="2023001",
    session_code="2024-11-25-AM",
    start_time="2024-11-25 08:00",
    end_time="2024-11-25 10:00",
    reason="病假",
)

# 检查是否有请假
has_leave = manager.has_leave("2023001", "2024-11-25-AM")

# 列出请假记录
leaves = manager.list_leaves()  # 所有请假
leaves = manager.list_leaves("2023001")  # 特定学生的请假

# 删除请假记录
manager.delete_leave(leave_id)
```

### 点名记录管理

```python
# 列出所有点名会话
roll_calls = manager.list_roll_calls()

# 获取点名会话的所有记录
records = manager.get_roll_call_records(roll_call_id=1)

# 更新记录状态
manager.update_record_status(record_id=1, new_status="present")

# 删除点名会话（包括所有记录）
manager.delete_roll_call(roll_call_id=1)
```

### 统计和查询

```python
# 获取统计信息
stats = manager.get_statistics()
print(f"学生总数: {stats['total_students']}")
print(f"总缺勤次数: {stats['total_cut_count']}")

# 打印学生列表
manager.print_students()

# 打印统计信息
manager.print_statistics()
```

## 方式二：使用命令行工具

### 学生管理命令

```bash
# 列出所有学生
python tools/db_manager.py student list

# 显示统计信息
python tools/db_manager.py student stats

# 添加学生
python tools/db_manager.py student add --id 2023011 --name 唐小新 --nickname 新新

# 更新学生
python tools/db_manager.py student update --id 2023001 --name 新姓名 --cut 5 --called 10

# 删除学生
python tools/db_manager.py student delete --id 2023001

# 重置学生统计
python tools/db_manager.py student reset --id 2023001

# 搜索学生
python tools/db_manager.py student search 唐小
```

### 请假管理命令

```bash
# 列出所有请假
python tools/db_manager.py leave list

# 添加请假
python tools/db_manager.py leave add \
    --student-id 2023001 \
    --session 2024-11-25-AM \
    --start "2024-11-25 08:00" \
    --end "2024-11-25 10:00" \
    --reason "病假"
```

## 方式三：使用辅助脚本

```bash
# 添加学生示例
python tools/db_helper.py add_student

# 更新学生示例
python tools/db_helper.py update_student

# 批量更新示例
python tools/db_helper.py batch_update

# 搜索学生
python tools/db_helper.py search 唐小

# 重置所有统计
python tools/db_helper.py reset_stats

# 查看统计
python tools/db_helper.py stats
```

## 方式四：直接使用Repository（高级）

如果需要更细粒度的控制，可以直接使用Repository：

```python
from data.sqlite_database import SQLiteDatabase
from data.repositories import SQLiteStudentRepository
from data.models import Student

db = SQLiteDatabase("data/roll_call.db")
repo = SQLiteStudentRepository(db)

# 查找
student = repo.find_by_id("2023001")

# 保存（新增或更新）
student = Student(
    student_id="2023001",
    name="新姓名",
    nickname="新昵称",
    cut_count=0,
    called_count=0,
)
repo.save(student)

# 删除
repo.delete("2023001")
```

## 常用操作示例

### 示例1：批量重置所有学生统计

```python
from tools.db_manager import DatabaseManager

manager = DatabaseManager()
students = manager.list_students()

for student in students:
    manager.reset_student_statistics(student.student_id)
    print(f"重置 {student.student_id} 的统计信息")

print(f"✓ 共重置 {len(students)} 名学生的统计信息")
```

### 示例2：批量添加学生

```python
from tools.db_manager import DatabaseManager

manager = DatabaseManager()

new_students = [
    ("2023011", "唐小新", "新新", "assets/images/students/student11.png"),
    ("2023012", "唐小亮", "亮亮", "assets/images/students/student12.png"),
    ("2023013", "唐小美", "美美", "assets/images/students/student13.png"),
]

for student_id, name, nickname, photo_path in new_students:
    manager.add_student(
        student_id=student_id,
        name=name,
        nickname=nickname,
        photo_path=photo_path,
    )
    print(f"✓ 添加学生: {student_id} - {name}")

print(f"✓ 共添加 {len(new_students)} 名学生")
```

### 示例3：修改特定学生的信息

```python
from tools.db_manager import DatabaseManager

manager = DatabaseManager()

# 更新学生信息
manager.update_student(
    "2023001",
    name="唐小雨（已改名）",
    nickname="小雨",
    cut_count=0,  # 清零缺勤
    called_count=20,  # 设置被点名次数
)

print("✓ 更新完成")
```

### 示例4：导出学生数据

```python
from tools.db_manager import DatabaseManager
import json

manager = DatabaseManager()
students = manager.list_students()

# 导出为JSON
data = [student.to_dict() for student in students]
with open("students_export.json", "w", encoding="utf-8") as f:
    json.dump(data, f, ensure_ascii=False, indent=2)

print(f"✓ 导出 {len(students)} 名学生数据到 students_export.json")
```

## 注意事项

1. **备份数据库**：修改前建议备份数据库文件
   ```bash
   cp data/roll_call.db data/roll_call.db.backup
   ```

2. **事务安全**：DatabaseManager的操作都是事务安全的，出错会自动回滚

3. **数据验证**：添加或更新数据时，确保数据格式正确

4. **外键约束**：删除学生时，相关的请假记录和点名记录可能受影响

## 快速参考

| 操作 | 命令 |
|------|------|
| 列出学生 | `python tools/db_manager.py student list` |
| 添加学生 | `python tools/db_manager.py student add --id 2023011 --name 唐小新` |
| 更新学生 | `python tools/db_manager.py student update --id 2023001 --name 新名` |
| 删除学生 | `python tools/db_manager.py student delete --id 2023001` |
| 搜索学生 | `python tools/db_manager.py student search 关键词` |
| 查看统计 | `python tools/db_manager.py student stats` |

## 更多帮助

查看命令行工具的帮助信息：

```bash
python tools/db_manager.py --help
python tools/db_manager.py student --help
python tools/db_manager.py leave --help
```

