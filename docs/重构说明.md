# 代码统计图表绘制逻辑重构说明

## 重构目标

将代码统计结果绘制逻辑重构为符合**开闭原则**的设计，使其易于扩展和维护。

## 重构内容

### 1. 创建的新文件

#### `ui/chart_types.py`
- **ChartStyle**: 样式配置数据类，集中管理所有样式参数
- **ChartType**: 图表类型抽象基类
- **BarChart**: 柱状图实现
- **PieChart**: 饼图实现
- **FunctionStatsChart**: 函数统计直方图实现
- **DetailTableChart**: 明细表实现

#### `ui/chart_layout.py`
- **LayoutStrategy**: 布局策略抽象基类
- **DefaultLayoutStrategy**: 默认2x2网格布局实现
- **CompactLayoutStrategy**: 紧凑布局实现（示例）

#### `ui/chart_data_extractor.py`
- **ChartDataExtractor**: 数据提取器，负责从统计结果中提取图表所需数据

#### `ui/chart_extension_example.py`
- 扩展示例，演示如何添加新图表类型和布局策略

### 2. 重构的文件

#### `ui/chart_renderer.py`
**主要变化：**
- 引入图表类型注册机制
- 使用布局策略模式
- 使用样式配置类
- 使用数据提取器
- 添加 `register_chart_type()` 方法支持扩展

**向后兼容性：**
- 保持原有公共接口不变
- `CodeStatisticsUI` 无需修改即可使用

## 设计优势

### ✅ 符合开闭原则

**之前：**
```python
# 添加新图表类型需要修改 _create_integrated_chart() 方法
def _create_integrated_chart(...):
    # 硬编码的图表绘制逻辑
    ax1.bar(...)  # 柱状图
    ax2.pie(...)  # 饼图
    # 添加新图表需要在这里修改代码
```

**现在：**
```python
# 添加新图表类型只需注册，无需修改现有代码
renderer.register_chart_type('line', LineChart(style=style))
```

### ✅ 职责分离

- **ChartType**: 负责图表绘制逻辑
- **LayoutStrategy**: 负责布局管理
- **ChartDataExtractor**: 负责数据提取
- **ChartRenderer**: 负责协调和组合

### ✅ 易于扩展

#### 添加新图表类型
```python
class LineChart(ChartType):
    def plot(self, ax, data):
        # 实现绘制逻辑
        pass
    
    def get_title(self):
        return "折线图"

# 注册使用
renderer.register_chart_type('line', LineChart(style=style))
```

#### 添加新布局策略
```python
class VerticalLayoutStrategy(LayoutStrategy):
    def create_layout(self, fig, chart_types, show_table):
        # 实现垂直布局
        pass

# 使用新布局
renderer = ChartRenderer(layout_strategy=VerticalLayoutStrategy())
```

#### 自定义样式
```python
style = ChartStyle(
    bar_color="#FF6B6B",
    title_fontsize=12,
    figure_size_without_table=(14, 10),
)
renderer = ChartRenderer(style=style)
```

## 使用示例

### 基本使用（向后兼容）
```python
# 无需修改现有代码
renderer = ChartRenderer()
renderer.show_code_statistics_charts(code_result, function_stats, ...)
```

### 扩展使用
```python
# 自定义样式
custom_style = ChartStyle(
    bar_color="#FF6B6B",
    histogram_color="#4ECDC4",
)

# 创建渲染器
renderer = ChartRenderer(style=custom_style)

# 注册新图表类型
renderer.register_chart_type('line', LineChart(style=custom_style))

# 使用自定义布局
vertical_layout = VerticalLayoutStrategy()
renderer = ChartRenderer(
    style=custom_style,
    layout_strategy=vertical_layout,
)
```

## 文件结构

```
ui/
├── chart_renderer.py          # 主渲染器（重构后）
├── chart_types.py              # 图表类型抽象和实现（新增）
├── chart_layout.py             # 布局策略抽象和实现（新增）
├── chart_data_extractor.py     # 数据提取器（新增）
├── chart_extension_example.py  # 扩展示例（新增）
└── code_statistics.py          # UI组件（无需修改）
```

## 测试建议

1. **功能测试**: 验证原有功能正常工作
2. **扩展测试**: 测试添加新图表类型和布局策略
3. **样式测试**: 测试自定义样式配置
4. **兼容性测试**: 验证与现有代码的兼容性

## 后续改进建议

1. **图表类型工厂**: 可以添加图表类型工厂模式，进一步简化注册
2. **配置外部化**: 可以将样式配置保存到配置文件
3. **主题系统**: 可以添加预设主题（如暗色主题、亮色主题）
4. **图表库抽象**: 可以抽象图表库接口，支持切换不同的图表库（matplotlib、plotly等）

## 总结

通过这次重构：
- ✅ 代码更符合SOLID原则，特别是开闭原则
- ✅ 扩展性显著提升，添加新功能无需修改现有代码
- ✅ 职责分离更清晰，代码更易维护
- ✅ 保持向后兼容，现有代码无需修改

